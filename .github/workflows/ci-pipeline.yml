# This is a basic workflow to help you get started with Actions

name: CI

# Controls when the action will run. 
on:
  # Triggers the workflow on push or pull request events but only for the main branch
  push:
    branches:
      - main
  pull_request:
    branches: 
      - main
env:
  maven_packages_cache: ".m2/repository"

  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:


# A workflow run is made up of one or more jobs that can run sequentially or in parallel
jobs:
  build:
    runs-on: self-hosted
    steps:
      - name: Cache
        uses: actions/cache@v2
        with:
          path: $maven_packages_cache
          key: ${{ runner.os }}-build
      - name: Checkout
        uses: actions/checkout@v2  
      - name: Build Webapplication
        run: mvn compile
      - name: artifacts
        uses: actions/upload-artifacts@v2
        with:
          name: target
          path: "target/*"  
        
  test:
    runs-on: self-hosted
    needs: build
    steps:
      - name: Cache
        uses: actions/cache@v2
        with:
          path: $maven_packages_cache
          key: ${{ runner.os }}-build
      - name: Run test
        run: mvn test

  package:
    runs-on: self-hosted
    needs: build
    steps:
      - name: Cache
        uses: actions/cache@v2
        with:
          path: $maven_packages_cache
          key: ${{ runner.os }}-build
      - name: Create war package
        run: mvn package -Dmaven.test.skip=true
      - name: artifacts
        uses: actions/upload-artifacts@v2
        with:
          name: war
          path: "target/*.war"  
        
  deploy_test:
    runs-on: self-hosted
    needs: package
    env:
      name: test
      action: start
      url: http://localhost:8081/game2048
      on_stop: stop_test
    steps:
      - name: Remove docker
        shell: bash
        run: docker rm --force game2048
      - name: Remove dockerimage
        shell: bash
        run: docker image rm --force game2048
      - name: Echo text
        shell: bash
        run: echo -e 'FROM tomcat:9.0.46-jdk11 \n COPY ./target/game2048.war /usr/local/tomcat/webapps' | docker build -t game2048 -f- .
      - name: Run docker
        shell: bash
        run: docker run --rm -d --name game2048 -p 8081:8080 game2048
     
  stop_test:
    runs-on: self-hosted
    env:
       name: test
       action: stop
    steps:
        - name: Remove docker
          shell: bash
          run: docker rm --force game2048
        - name: Remove dockerimage
          shell: bash
          run: docker image rm --force game2048
